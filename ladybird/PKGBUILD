## WIP

# Contributor: Francesco Gazzetta <https://github.com/fgaz>
# https://github.com/NixOS/nixpkgs/blob/master/pkgs/applications/networking/browsers/ladybird/default.nix

pkgname=ladybird
pkgver=r122.d69ad73
pkgrel=1
pkgdesc="A browser using the SerenityOS LibWeb engine with a Qt GUI."
arch=('x86_64')
url="https://github.com/SerenityOS/ladybird"
license=('BSD')
depends=('libgl' 'qt6-base' 'qt6-wayland')
makedepends=('cmake' 'git' 'ninja' 'qt6-tools' 'unzip')
optdepends=()
options=('!lto')
_commit=d69ad7332477de33bfd1963026e057d55c6f222d
_serenity_commit=a0f3e2c9a2b82117aa7c1a3444ad0d31baa070d5
source=("git+https://github.com/SerenityOS/ladybird.git#commit=$_commit"
        "git+https://github.com/SerenityOS/serenity.git#commit=$_serenity_commit")
sha256sums=('SKIP'
            'SKIP')

pkgver() {
  cd "$srcdir/$pkgname"
  printf "r%s.%s" "$(git rev-list --count HEAD)" "$(git rev-parse --short HEAD)"
}

build() {

  ## TODO

  # prevent static lib mangling with LTO
#  CFLAGS+=" -ffat-lto-objects"
#  CXXFLAGS+=" -ffat-lto-objects"

#    -DBUILD_SHARED_LIBS='OFF' \
#    -DENABLE_TIME_ZONE_DATABASE_DOWNLOAD='false' \
#    -DENABLE_UNICODE_DATABASE_DOWNLOAD='false' \

  cmake -GNinja -B build -S "$pkgname" \
    -DCMAKE_BUILD_TYPE='None' \
    -DCMAKE_INSTALL_PREFIX='/usr' \
    -DSERENITY_SOURCE_DIR="$srcdir/serenity" \
    -Wno-dev
  ninja -C build
}

package() {
  DESTDIR="$pkgdir" ninja install -C build

  cd "$srcdir/$pkgname"
  install -Dm644 LICENSE.md -t "$pkgdir/usr/share/licenses/$pkgname/"
}
